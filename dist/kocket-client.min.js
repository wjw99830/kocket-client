!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Kocket=t()}(this,function(){"use strict";function e(e,t,n,s){return new(n||(n=Promise))(function(r,i){function o(e){try{d(s.next(e))}catch(e){i(e)}}function a(e){try{d(s.throw(e))}catch(e){i(e)}}function d(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}d((s=s.apply(e,t||[])).next())})}const t=()=>{};class n{constructor(e){this.event=e}getRawData(){return this.event.data}getJson(){try{return JSON.parse(this.event.data)}catch(e){return null}}getBlob(e){return new Blob([this.event.data],e)}getDataURL(){return new Promise(e=>{const t=new FileReader;t.addEventListener("loadend",()=>{e(t.result)}),t.readAsDataURL(this.getBlob())})}}return class extends WebSocket{constructor(e,t){super(e,t),this._middlewares=new Set,this._connect()}use(e){return this._middlewares.add(e),this}unuse(e){return this._middlewares.delete(e),this}send(e){if(t=e,"Object"===Object.prototype.toString.call(t).replace("]","").split(" ")[1])try{super.send(JSON.stringify(e))}catch(e){}else super.send(e);var t}_connect(){this.addEventListener("message",e=>{this._applyMiddlewares(e)})}_applyMiddlewares(s){const r=[],i=Array.from(this._middlewares),o=i.length,a=new n(s);for(let n=0;n<o;n++){const s=()=>e(this,void 0,void 0,function*(){const e=i[n+1]||t;yield e(a,r[n+1])});r.push(s)}(i[0]||t)(a,r[0]||t)}}});
